{% load static %}

<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage or Add Class Schedule</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Nunito&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static '/css/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
</head>    
<body>
    <nav class="navbar">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling"
                aria-controls="#offcanvasScrolling">
            <i class="fa fa-solid fa-bars fa-2x nav-icon"></i>
        </button>
        <a class="text-decoration-none nav-header-font" href="/profile">Admin Panel</a>
        <div class="offcanvas offcanvas-start show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
            <div class="offcanvas-header">
                <!--<button type="button" class="btn-close text-reset btn-lg" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>-->
            </div>
            <div class="offcanvas-body">                
                <p class="offcanvas-header-font text-center" style="margin-bottom:30px">Attendance Management System</p>
                <hr />
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/profile" style="padding-left: 10px"><i class="fa fa-solid fa-house"></i><span style="padding-left: 10px">Profile</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register" style="padding-left: 10px"><i class="fa fa-solid fa-graduation-cap"></i><span style="padding-left: 10px">Users</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/student" style="padding-left: 10px"><i class="fa fa-solid fa-graduation-cap"></i><span style="padding-left: 10px">Students</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher" style="padding-left: 10px"><i class="fa fa-solid fa-chalkboard-user"></i><span style="padding-left: 10px">Teachers</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/courses" style="padding-left: 10px"><i class="fa fa-solid fa-book"></i><span style="padding-left: 10px">Courses</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/subjects" style="padding-left: 10px"><i class="fa fa-solid fa-location-arrow"></i><span style="padding-left: 10px">Subjects</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/course_subjects" style="padding-left: 10px"><i class="fa fa-solid fa-building"></i><span style="padding-left: 10px">Course Subjects</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher_course" style="padding-left: 10px"><i class="fa fa-solid fa-book-open-reader"></i><span style="padding-left: 10px">Teacher Courses</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/student_course" style="padding-left: 10px"><i class="fa fa-solid fa-credit-card"></i><span style="padding-left: 10px">Student Courses</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/classes" style="padding-left: 10px"><i class="fa fa-solid fa-graduation-cap"></i><span style="padding-left: 10px">Classes</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/class_schedule" style="padding-left: 10px"><i class="fa fa-solid fa-graduation-cap"></i><span style="padding-left: 10px">Class Schedules</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/student_schedule" style="padding-left: 10px"><i class="fa fa-solid fa-book"></i><span style="padding-left: 10px">Student Schedule</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/teacher_schedule" style="padding-left: 10px"><i class="fa fa-solid fa-book"></i><span style="padding-left: 10px">Teacher Schedule</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/student_attendance" style="padding-left: 10px"><i class="fa fa-solid fa-book"></i><span style="padding-left: 10px">Student Attendance</span></a>
                    </li>     
                    <li class="nav-item">
                        <a class="nav-link" href="/" style="padding-left: 10px" id="logoutBtn"><i class="fa fa-solid fa-book"></i><span style="padding-left: 10px">Logout</span></a>
                    </li>                
                </ul>
            </div>
        </div>
    </nav>        
    
    <div class="container" style="width: 100%; margin:auto; padding-left: 200px; margin-top: 50px;">
        <h1 style="margin-bottom: 20px;"><b>ADD OR UPDATE CLASS SCHEDULE</b></h1>
        <form id="scheduleForm" style="padding: -100px;">
            {% csrf_token %}
            <label class="lbl-text">Class Id</label>
            <input type="text" name="class_id" class="form-control" placeholder="Class Id" id="classId">
            <label class="lbl-text">Subject Id</label>
            <input type="text" name="subject_id" class="form-control" placeholder="Subject Id" id="subjectId">            
            <label class="lbl-text">Day</label>
            <input type="text" name="day" class="form-control" placeholder="Day" id="dayId">
            <label class="lbl-text">Start Time</label>
            <input type="text" name="start_time" class="form-control" placeholder="Start Time" id="sTimeId">
            <label class="lbl-text">End Time</label>
            <input type="text" name="end_time" class="form-control" placeholder="End Time" id="eTimeId">
            <label class="lbl-text">Class Venue</label>
            <input type="text" name="class_venue" class="form-control" placeholder="Venue" id="venueId">
            <button type="submit" class="btn btn-primary btn-add" data-target="#myModal" style="margin-top: 20px;">Add Schedule</button>
        </form>             
        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Success</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body" id="modal-text">
                Schedule Added Successfully.
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="javascript:window.location.reload()">OK</button>
                </div>
            </div>
            </div>
        </div>
        
        <h1 style="margin-top: 100px; margin-bottom: 40px;"><b>SCHEDULE LIST</b></h1>     
        <div class="input-group rounded">
            <input type="search" class="form-control rounded" onkeyup="myFunction()" id="myFilter" placeholder="Search" aria-label="Search" aria-describedby="search-addon" />
            <button type="button" class="btn btn-primary"  style="height: 50px; margin-left: 20px;">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <div class="schedule_list row" id="myUsers" style="margin-bottom: 200px; margin-left: 2px; margin-top: 50px;">

        </div>
        <script>
            if (localStorage.getItem('token') == null) {
                    window.location = "http://127.0.0.1:8000/"
                }
            const myForm = document.getElementById('scheduleForm');

            myForm.addEventListener('submit', function(e) {
                e.preventDefault();
            
            const formData = new FormData(this);
            const searchParams = new URLSearchParams();                    

            for (const pair of formData) {
                searchParams.append(pair[0], pair[1])
            }        

            fetch('http://127.0.0.1:8000/api/class_schedules/', {
                method: 'post',
                body: searchParams
            }).then(function (response){
                if (response.ok) {                    
                    $('#myModal').modal('toggle')                               
                    myForm.reset()
                    return response.text();
                } else {
                    console.log("Could not register schedule");
                }
                
            }).catch(function (error){
                console.error(error);
            })
            });
            const submitBtn = document.querySelector('.btn-add')
            const scheduleList = document.querySelector('.schedule_list');
            // METHOD - GET 
            fetch('http://127.0.0.1:8000/api/class_schedules/')
                .then(function (response) {
                    return response.json()
                })
                .then(function (data) {
                    console.log(data)
                    data.forEach(function (element) {
                        console.log(element)
                        
                        var row = `<div class="card col-lg-6" style="width: 21rem; margin-right: 50px; margin-bottom:30px">
                                        <div class="card-body text-center" data-id=${element.id}>  
                                            <h5 class="card-title" style="margin-top:10px">Class Schedule ID: <span class="csid">${element.id}</span></h5>                                          
                                            <h5 class="card-title" style="margin-top:10px">Class ID: <span class="cid">${element.class_id}</span></h5>
                                            <h5 class="card-title">Subject ID: <span class="sid">${element.subject_id}</span></h5>
                                            <h6 class="card-text">Day: <span class="did">${element.day}</span></h6>
                                            <h6 class="card-text">Start Time: <span class="stid">${element.start_time}</span></h6>
                                            <h6 class="card-text">End Time: <span class="etid">${element.end_time}</span></h6>
                                            <h6 class="card-text">Venue (Classroom): <span class="vid">${element.class_venue}</span></h6>
                                            <a href="#" class="card-link" id="editBtn" style="color:blue">Edit</a>
                                            <a href="#" class="card-link" id="deleteBtn" style="color:blue">Delete</a>
                                        </div>
                                    </div>`
                        
                        scheduleList.innerHTML += row
                    });
                })

                scheduleList.addEventListener('click', function(e) {
                e.preventDefault();
                let editButtonPressed = e.target.id == 'editBtn';
                let deleteButtonPressed = e.target.id == 'deleteBtn';     


                let id = e.target.parentElement.dataset.id           
                
                console.log(id)

                if (deleteButtonPressed) {   
                    fetch('http://127.0.0.1:8000/api/class_schedules/' + id, {
                        method: 'DELETE',                        
                        })
                        .then(function (response) {
                            return response.text()
                        }) 
                        .then(function () {
                            location.reload()
                        })
                    
                }
                
                if (editButtonPressed) {
                    const parent = e.target.parentElement;
                    let classId = parent.querySelector('.cid').textContent;
                    let subjectId = parent.querySelector('.sid').textContent;
                    let dayId = parent.querySelector('.did').textContent;
                    let sTimeId = parent.querySelector('.stid').textContent;
                    let eTimeId = parent.querySelector('.etid').textContent;
                    let venueId = parent.querySelector('.vid').textContent;
                   

                    document.getElementById("classId").value = classId;
                    document.getElementById("subjectId").value = subjectId;
                    document.getElementById("dayId").value = dayId;
                    document.getElementById("sTimeId").value = sTimeId;
                    document.getElementById("eTimeId").value = eTimeId;
                    document.getElementById("venueId").value = venueId;
                }

                // Method - PATCH Update
                submitBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    fetch('http://127.0.0.1:8000/api/class_schedules/' + id +"/", {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            class_id: document.getElementById("classId").value,
                            subject_id: document.getElementById("subjectId").value,
                            day: document.getElementById("dayId").value,
                            start_time: document.getElementById("sTimeId").value,
                            end_time: document.getElementById("eTimeId").value,
                            venue: document.getElementById("venueId").value,
                        })
                    })
                    .then(function (response) {
                        return response.json()
                    })
                    .then(function () {
                        document.getElementById("modal-text").innerHTML = "Schedule Updated Successfully."
                        $('#myModal').modal('toggle') 
                        location.reload()
                    })
                })
            })
            function myFunction() {
                let input, filter, cards, cardContainer, title, i;
                input = document.getElementById("myFilter");
                filter = input.value.toUpperCase();
                cardContainer = document.getElementById("myUsers");
                cards = cardContainer.getElementsByClassName("card");
                for (i = 0; i < cards.length; i++) {
                    title = cards[i].querySelector(".card-title");
                    if (title.innerText.toUpperCase().indexOf(filter) > -1) {
                    cards[i].style.display = "";
                    } else {
                    cards[i].style.display = "none";
                    }
                }
                }
        </script>
    </div>
    <script src="{% static '/js/logout.js' %}">        
    </script>
</body></html>